weights = ifelse(df_clustering$dominant_outcome == "Low Variance",
class_weights["Low Variance"],
class_weights["High Variance"]),
control = rpart.control(
cp = 0.02,
minsplit = 10,
minbucket = 5,
maxdepth = 10
)
)
# Save a very high resolution plot to see all details
png("tree_high_res.png", width = 7000, height = 3000, res = 300)
# rpart.plot(cart_purity,
#            type = 4,
#            extra = 104,
#            under = FALSE,
#            faclen = 0,
#            cex = 0.6,  # Smaller text to fit more
#            tweak = 1.2)
#
rpart.plot(
cart_purity,
type = 4,
extra = 104,
under = TRUE,      # put labels underneath
faclen = 0,
cex = 0.6,
tweak = 1.2,
fallen.leaves = TRUE,
nn = TRUE          # <— shows node numbers on the plot
)
dev.off()
# Get full frame info
frame_info <- cart_purity$frame
# Add node IDs
frame_info$node_id <- as.numeric(row.names(frame_info))
terminal_nodes = frame_info %>%
dplyr::filter(var == "<leaf>") %>%
dplyr::mutate(
Node_ID = as.numeric(row.names(.)),
Predicted_Class = ifelse(yval == 1, "High Variance", "Low Variance"),
N_Samples = n,
P_HighVar = yval2[, 4],
P_LowVar  = yval2[, 5],
Node_Percent = yval2[, 6]
) %>%
dplyr::select(Node_ID, Predicted_Class, N_Samples, P_HighVar, P_LowVar, Node_Percent)
rm(list=ls())
library(dplyr)
library(tidyr)
library(ggplot2)
library(purrr)
library(readr)  # For read_csv
library(stringr)
library(zoo)
source("/Users/burcutepekule/Dropbox/Treg_problem_v2/MISC/PLOT_FUNCTIONS.R")
inj_type             = 'sterile'
ss_start_threshold   = 4500
t_max                = 5000
tol_in               = 25*0.25
# df_raw    = readRDS('/Users/burcutepekule/Desktop/tregs/all_comparison_results_sterile_1_trnd_0_old.rds')
# df_raw    = readRDS('/Users/burcutepekule/Desktop/tregs/all_comparison_results_sterile_1_trnd_0.rds')
df_raw    = readRDS('/Users/burcutepekule/Desktop/tregs/all_comparison_results_A13_sterile_1_trnd_0.rds')
length(unique(df_raw$param_set_id))
df_params = read_csv('/Users/burcutepekule/Desktop/tregs/original_lhs_parameters.csv', show_col_types = FALSE)
hist(df_raw$mean_treg_off)
hist(df_raw$mean_treg_on)
df_raw_keep = df_raw
df_raw = df_raw %>% dplyr::filter(comparison=='Treg_OFF_ON' & injury_type==inj_type)
hist(df_raw_keep$mean_diff)
#----- filter based on ss_start, it cannot be too large otherwise not much to compare!
param_id_all_below = df_raw %>%
dplyr::group_by(param_set_id) %>%
dplyr::summarise(all_below = all(ss_start_tregs_off <= ss_start_threshold & ss_start_tregs_on <= ss_start_threshold), .groups = "drop") %>%
dplyr::filter(all_below) %>%
dplyr::pull(param_set_id)
df_raw = df_raw %>% dplyr::filter(param_set_id %in% param_id_all_below)
df_raw     = df_raw %>% dplyr::mutate(abs_cohens_d = abs(cohens_d))
df_raw     = df_raw %>% dplyr::mutate(effect_size = case_when(
abs_cohens_d < 0.2 ~ "Negligible",
abs_cohens_d < 0.5 & abs_cohens_d>= 0.2  ~ "Small",
abs_cohens_d < 0.8 & abs_cohens_d>= 0.5 ~ "Medium",
TRUE ~ "Large"
))
df_raw_plot_nz = df_raw %>% dplyr::filter(effect_size %in% c("Medium","Large") & (mean_diff_on_off>tol_in | mean_diff_on_off<(-1*tol_in)))
df_raw_plot_z  = df_raw %>% dplyr::filter((mean_diff_on_off<=tol_in & mean_diff_on_off>=(-1*tol_in))) # this is not true- what about effect_size small but abs(mean_diff)>tol_in?
df_raw_plot    = rbind(df_raw_plot_z, df_raw_plot_nz)
hist(df_raw_plot$mean_diff,30)
x   = df_raw_plot$mean_diff
round(100*sum(x>tol_in)/length(x),2)
round(100*sum(x<=tol_in & x>=(-1*tol_in))/length(x),2)
round(100*sum(x<(-1*tol_in))/length(x),2)
hist(x,30)
#-----------
# var_df = df_raw_plot %>%
var_df = df_raw %>%
group_by(param_set_id) %>%
summarise(
sd_on = sd(mean_treg_on),
sd_off = sd(mean_treg_off),
mean_on = mean(mean_treg_on),
mean_off = mean(mean_treg_off),
mean = mean(mean_diff_on_off),
min = min(mean_diff_on_off),
max = max(mean_diff_on_off),
variance = var(mean_diff_on_off),
sd = sd(mean_diff_on_off),
n_replicates = n()
) %>%
arrange(desc(variance))
df_raw = df_raw %>% inner_join(var_df, by='param_set_id')
df_raw = df_raw %>% dplyr::mutate(high_var = ifelse(sd_on>1 & sd_off>1,1,0))
df_raw = df_raw %>% inner_join(df_params, by='param_set_id')
View(df_raw)
df_raw = df_raw %>% dplyr::filter(high_var==0)
View(df_raw)
hist(df_raw$mean)
View(df_raw)
df_raw   = df_raw %>% dplyr::filter(high_var==0)
rm(list=ls())
library(dplyr)
library(tidyr)
library(ggplot2)
library(purrr)
library(readr)  # For read_csv
library(stringr)
library(zoo)
source("/Users/burcutepekule/Dropbox/Treg_problem_v2/MISC/PLOT_FUNCTIONS.R")
inj_type             = 'sterile'
ss_start_threshold   = 4500
t_max                = 5000
tol_in               = 25*0.25
# df_raw    = readRDS('/Users/burcutepekule/Desktop/tregs/all_comparison_results_sterile_1_trnd_0_old.rds')
# df_raw    = readRDS('/Users/burcutepekule/Desktop/tregs/all_comparison_results_sterile_1_trnd_0.rds')
df_raw    = readRDS('/Users/burcutepekule/Desktop/tregs/all_comparison_results_A13_sterile_1_trnd_0.rds')
length(unique(df_raw$param_set_id))
df_params = read_csv('/Users/burcutepekule/Desktop/tregs/original_lhs_parameters.csv', show_col_types = FALSE)
hist(df_raw$mean_treg_off)
hist(df_raw$mean_treg_on)
df_raw_keep = df_raw
df_raw = df_raw %>% dplyr::filter(comparison=='Treg_OFF_ON' & injury_type==inj_type)
hist(df_raw_keep$mean_diff)
#----- filter based on ss_start, it cannot be too large otherwise not much to compare!
param_id_all_below = df_raw %>%
dplyr::group_by(param_set_id) %>%
dplyr::summarise(all_below = all(ss_start_tregs_off <= ss_start_threshold & ss_start_tregs_on <= ss_start_threshold), .groups = "drop") %>%
dplyr::filter(all_below) %>%
dplyr::pull(param_set_id)
df_raw = df_raw %>% dplyr::filter(param_set_id %in% param_id_all_below)
df_raw     = df_raw %>% dplyr::mutate(abs_cohens_d = abs(cohens_d))
df_raw     = df_raw %>% dplyr::mutate(effect_size = case_when(
abs_cohens_d < 0.2 ~ "Negligible",
abs_cohens_d < 0.5 & abs_cohens_d>= 0.2  ~ "Small",
abs_cohens_d < 0.8 & abs_cohens_d>= 0.5 ~ "Medium",
TRUE ~ "Large"
))
df_raw_plot_nz = df_raw %>% dplyr::filter(effect_size %in% c("Medium","Large") & (mean_diff_on_off>tol_in | mean_diff_on_off<(-1*tol_in)))
df_raw_plot_z  = df_raw %>% dplyr::filter((mean_diff_on_off<=tol_in & mean_diff_on_off>=(-1*tol_in))) # this is not true- what about effect_size small but abs(mean_diff)>tol_in?
df_raw_plot    = rbind(df_raw_plot_z, df_raw_plot_nz)
hist(df_raw_plot$mean_diff,30)
x   = df_raw_plot$mean_diff
round(100*sum(x>tol_in)/length(x),2)
round(100*sum(x<=tol_in & x>=(-1*tol_in))/length(x),2)
round(100*sum(x<(-1*tol_in))/length(x),2)
hist(x,30)
#-----------
# var_df = df_raw_plot %>%
var_df = df_raw %>%
group_by(param_set_id) %>%
summarise(
sd_on = sd(mean_treg_on),
sd_off = sd(mean_treg_off),
mean_on = mean(mean_treg_on),
mean_off = mean(mean_treg_off),
mean = mean(mean_diff_on_off),
min = min(mean_diff_on_off),
max = max(mean_diff_on_off),
variance = var(mean_diff_on_off),
sd = sd(mean_diff_on_off),
n_replicates = n()
) %>%
arrange(desc(variance))
df_raw = df_raw %>% inner_join(var_df, by='param_set_id')
df_raw = df_raw %>% dplyr::mutate(high_var = ifelse(sd_on>1 & sd_off>1,1,0))
df_raw = df_raw %>% inner_join(df_params, by='param_set_id')
df_raw_low_var   = df_raw %>% dplyr::filter(high_var==0)
df_check = distinct(df_raw_low_var[c('param_set_id','mean','high_var')])
hist(df_check$mean) #!!!! -> THERE ARE TREGS BEING USEFUL IN THE LOW VARIANCE CASES! NEGATIVES ARE INSIGNIFICANT!
View(df_check)
dim(df_check)
View(df_check)
plot_param_vs_param(df_check,'activation_threshold_DAMPs_density','mean')
df_check = df_check %>% inner_join(df_params, by='param_set_id')
plot_param_vs_param(df_check,'activation_threshold_DAMPs_density','mean')
View(df_check)
colnames(df_check)
plot_param_vs_param(df_check,'activation_threshold_DAMPs','mean')
plot_param_vs_param(df_check,'activation_threshold_SAMPs','mean')
View(df_check)
df_check_nz = df_check %>% dplyr::filter(mean>0)
plot_param_vs_param(df_check_nz,'activation_threshold_DAMPs','mean')
plot_param_vs_param(df_check_nz,'activation_threshold_SAMPs','mean')
plot_param_vs_param(df_check_nz,'active_age_limit','mean')
plot_param_vs_param(df_check_nz,'th_ROS_epith_recover','mean')
plot_param_vs_param(df_check_nz,'ros_decay','mean')
plot_param_vs_param(df_check_nz,'treg_discrimination_efficiency','mean')
plot_param_vs_param(df_check_nz,'SAMPs_decay','mean')
plot_param_vs_param(df_check_low_var_nz,'activation_threshold_DAMPs','mean')
rm(list=ls())
library(dplyr)
library(tidyr)
library(ggplot2)
library(purrr)
library(readr)  # For read_csv
library(stringr)
library(zoo)
source("/Users/burcutepekule/Dropbox/Treg_problem_v2/MISC/PLOT_FUNCTIONS.R")
inj_type             = 'sterile'
ss_start_threshold   = 4500
t_max                = 5000
tol_in               = 25*0.25
# df_raw    = readRDS('/Users/burcutepekule/Desktop/tregs/all_comparison_results_sterile_1_trnd_0_old.rds')
# df_raw    = readRDS('/Users/burcutepekule/Desktop/tregs/all_comparison_results_sterile_1_trnd_0.rds')
df_raw    = readRDS('/Users/burcutepekule/Desktop/tregs/all_comparison_results_A13_sterile_1_trnd_0.rds')
length(unique(df_raw$param_set_id))
df_params = read_csv('/Users/burcutepekule/Desktop/tregs/original_lhs_parameters.csv', show_col_types = FALSE)
hist(df_raw$mean_treg_off)
hist(df_raw$mean_treg_on)
df_raw_keep = df_raw
df_raw = df_raw %>% dplyr::filter(comparison=='Treg_OFF_ON' & injury_type==inj_type)
hist(df_raw_keep$mean_diff)
#----- filter based on ss_start, it cannot be too large otherwise not much to compare!
param_id_all_below = df_raw %>%
dplyr::group_by(param_set_id) %>%
dplyr::summarise(all_below = all(ss_start_tregs_off <= ss_start_threshold & ss_start_tregs_on <= ss_start_threshold), .groups = "drop") %>%
dplyr::filter(all_below) %>%
dplyr::pull(param_set_id)
df_raw = df_raw %>% dplyr::filter(param_set_id %in% param_id_all_below)
df_raw     = df_raw %>% dplyr::mutate(abs_cohens_d = abs(cohens_d))
df_raw     = df_raw %>% dplyr::mutate(effect_size = case_when(
abs_cohens_d < 0.2 ~ "Negligible",
abs_cohens_d < 0.5 & abs_cohens_d>= 0.2  ~ "Small",
abs_cohens_d < 0.8 & abs_cohens_d>= 0.5 ~ "Medium",
TRUE ~ "Large"
))
df_raw_plot_nz = df_raw %>% dplyr::filter(effect_size %in% c("Medium","Large") & (mean_diff_on_off>tol_in | mean_diff_on_off<(-1*tol_in)))
df_raw_plot_z  = df_raw %>% dplyr::filter((mean_diff_on_off<=tol_in & mean_diff_on_off>=(-1*tol_in))) # this is not true- what about effect_size small but abs(mean_diff)>tol_in?
df_raw_plot    = rbind(df_raw_plot_z, df_raw_plot_nz)
hist(df_raw_plot$mean_diff,30)
x   = df_raw_plot$mean_diff
round(100*sum(x>tol_in)/length(x),2)
round(100*sum(x<=tol_in & x>=(-1*tol_in))/length(x),2)
round(100*sum(x<(-1*tol_in))/length(x),2)
hist(x,30)
#-----------
# var_df = df_raw_plot %>%
var_df = df_raw %>%
group_by(param_set_id) %>%
summarise(
sd_on = sd(mean_treg_on),
sd_off = sd(mean_treg_off),
mean_on = mean(mean_treg_on),
mean_off = mean(mean_treg_off),
mean = mean(mean_diff_on_off),
min = min(mean_diff_on_off),
max = max(mean_diff_on_off),
variance = var(mean_diff_on_off),
sd = sd(mean_diff_on_off),
n_replicates = n()
) %>%
arrange(desc(variance))
df_raw = df_raw %>% inner_join(var_df, by='param_set_id')
df_raw = df_raw %>% dplyr::mutate(high_var = ifelse(sd_on>1 & sd_off>1,1,0))
df_raw = df_raw %>% inner_join(df_params, by='param_set_id')
df_raw_low_var   = df_raw %>% dplyr::filter(high_var==0)
df_check_low_var = distinct(df_raw_low_var[c('param_set_id','mean','high_var')])
hist(df_check$mean) #!!!! -> THERE ARE TREGS BEING USEFUL IN THE LOW VARIANCE CASES! NEGATIVES ARE INSIGNIFICANT!
View(df_raw_low_var)
hist(df_check_low_var$mean) #!!!! -> THERE ARE TREGS BEING USEFUL IN THE LOW VARIANCE CASES! NEGATIVES ARE INSIGNIFICANT!
#### --- BE CAREFUL INTERPRETING HERE: THESE ARE THE "STABLE" CASES WITH LOW VARIATION
#### --- THEY MIGHT NOT AGREE WITH THE HISTOGRAMS FOR DECIDING LOW/HIGH VARIATION BECAUSE THAT'S A DIFFERENT THING!
#### ---
df_check_low_var    = df_check_low_var %>% inner_join(df_params, by='param_set_id')
df_check_low_var_nz = df_check_low_var %>% dplyr::filter(mean>0)
plot_param_vs_param(df_check_low_var_nz,'activation_threshold_DAMPs','mean')
plot_param_vs_param(df_check_low_var_nz,'activation_threshold_SAMPs','mean')
plot_param_vs_param(df_check_low_var_nz,'activation_threshold_DAMPs','mean')
plot_param_vs_param(df_check_low_var_nz,'activation_threshold_SAMPs','mean')
plot_param_vs_param(df_check_low_var_nz,'th_ROS_epith_recover','mean')
plot_param_vs_param(df_check_low_var_nz,'ros_decay','mean')
plot_param_vs_param(df_check_low_var_nz,'SAMPs_decay','mean')
plot_param_vs_param(df_check_low_var_nz,'DAMPs_decay','mean') # same goes for this too
rm(list=ls())
library(dplyr)
library(tidyr)
library(ggplot2)
library(purrr)
library(readr)  # For read_csv
library(stringr)
library(zoo)
source("/Users/burcutepekule/Dropbox/Treg_problem_v2/MISC/PLOT_FUNCTIONS.R")
inj_type             = 'sterile'
ss_start_threshold   = 4500
t_max                = 5000
tol_in               = 25*0.25
# df_raw    = readRDS('/Users/burcutepekule/Desktop/tregs/all_comparison_results_sterile_1_trnd_0_old.rds')
# df_raw    = readRDS('/Users/burcutepekule/Desktop/tregs/all_comparison_results_sterile_1_trnd_0.rds')
df_raw    = readRDS('/Users/burcutepekule/Desktop/tregs/all_comparison_results_A13_sterile_1_trnd_0.rds')
length(unique(df_raw$param_set_id))
rm(list=ls())
library(dplyr)
library(tidyr)
library(ggplot2)
library(purrr)
library(readr)  # For read_csv
library(stringr)
library(zoo)
library(mgcv)
library(factoextra)
library(cluster)
source("/Users/burcutepekule/Dropbox/Treg_problem_v2/MISC/PLOT_FUNCTIONS.R")
source("~/Desktop/tregs/A013_datazanalyse_sterile_1_rnd_0.R")
df_plot = readRDS('df_plot_A13.rds') # comes from
# # ---------- Conditional Inference Trees (CTree): These use statistical tests for splitting and handle interactions better:
library(partykit)
# vector of parameter names
param_names = c(
"th_ROS_microbe",
"th_ROS_epith_recover",
"epith_recovery_chance",
"rat_com_pat_threshold",
"diffusion_speed_DAMPs",
"diffusion_speed_SAMPs",
"diffusion_speed_ROS",
"add_ROS",
"add_DAMPs",
"add_SAMPs",
"ros_decay",
"DAMPs_decay",
"SAMPs_decay",
"activation_threshold_DAMPs",
"activation_threshold_SAMPs",
"activity_engulf_M0_baseline",
"activity_engulf_M1_baseline",
"activity_engulf_M2_baseline",
"activity_ROS_M1_baseline",
"rate_leak_commensal_injury",
"rate_leak_pathogen_injury",
"rate_leak_commensal_baseline",
"active_age_limit",
"treg_discrimination_efficiency"
)
df_clustering = distinct(df_plot[c('high_var',param_names)])
df_clustering = df_clustering %>%
mutate(dominant_outcome = factor(high_var, levels = c("High Variance","Low Variance")))
library(rpart)
library(rpart.plot)
# Calculate class weights (inverse of frequency)
class_weights = 1 / prop.table(table(df_clustering$dominant_outcome))
cart_purity = rpart(
dominant_outcome ~ .,
data = df_clustering %>% select(dominant_outcome, all_of(param_names)),
method = "class",
weights = ifelse(df_clustering$dominant_outcome == "Low Variance",
class_weights["Low Variance"],
class_weights["High Variance"]),
control = rpart.control(
cp = 0.02,
minsplit = 10,
minbucket = 5,
maxdepth = 10
)
)
# Save a very high resolution plot to see all details
png("tree_high_res.png", width = 7000, height = 3000, res = 300)
# rpart.plot(cart_purity,
#            type = 4,
#            extra = 104,
#            under = FALSE,
#            faclen = 0,
#            cex = 0.6,  # Smaller text to fit more
#            tweak = 1.2)
#
rpart.plot(
cart_purity,
type = 4,
extra = 104,
under = TRUE,      # put labels underneath
faclen = 0,
cex = 0.6,
tweak = 1.2,
fallen.leaves = TRUE,
nn = TRUE          # <— shows node numbers on the plot
)
dev.off()
# Get full frame info
frame_info <- cart_purity$frame
# Add node IDs
frame_info$node_id <- as.numeric(row.names(frame_info))
terminal_nodes = frame_info %>%
dplyr::filter(var == "<leaf>") %>%
dplyr::mutate(
Node_ID = as.numeric(row.names(.)),
Predicted_Class = ifelse(yval == 1, "High Variance", "Low Variance"),
N_Samples = n,
P_HighVar = yval2[, 4],
P_LowVar  = yval2[, 5],
Node_Percent = yval2[, 6]
) %>%
dplyr::select(Node_ID, Predicted_Class, N_Samples, P_HighVar, P_LowVar, Node_Percent)
rm(list=ls())
library(dplyr)
library(tidyr)
library(ggplot2)
library(purrr)
library(readr)  # For read_csv
library(stringr)
library(zoo)
library(mgcv)
library(factoextra)
library(cluster)
source("/Users/burcutepekule/Dropbox/Treg_problem_v2/MISC/PLOT_FUNCTIONS.R")
source("~/Desktop/tregs/A013_datazanalyse_sterile_1_rnd_0.R")
df_plot = readRDS('df_plot_A13.rds') # comes from
# # ---------- Conditional Inference Trees (CTree): These use statistical tests for splitting and handle interactions better:
library(partykit)
# vector of parameter names
param_names = c(
"th_ROS_microbe",
"th_ROS_epith_recover",
"epith_recovery_chance",
"rat_com_pat_threshold",
"diffusion_speed_DAMPs",
"diffusion_speed_SAMPs",
"diffusion_speed_ROS",
"add_ROS",
"add_DAMPs",
"add_SAMPs",
"ros_decay",
"DAMPs_decay",
"SAMPs_decay",
"activation_threshold_DAMPs",
"activation_threshold_SAMPs",
"activity_engulf_M0_baseline",
"activity_engulf_M1_baseline",
"activity_engulf_M2_baseline",
"activity_ROS_M1_baseline",
"rate_leak_commensal_injury",
"rate_leak_pathogen_injury",
"rate_leak_commensal_baseline",
"active_age_limit",
"treg_discrimination_efficiency"
)
df_clustering = distinct(df_plot[c('high_var',param_names)])
df_clustering = df_clustering %>%
mutate(dominant_outcome = factor(high_var, levels = c("High Variance","Low Variance")))
library(rpart)
library(rpart.plot)
# Calculate class weights (inverse of frequency)
class_weights = 1 / prop.table(table(df_clustering$dominant_outcome))
cart_purity = rpart(
dominant_outcome ~ .,
data = df_clustering %>% select(dominant_outcome, all_of(param_names)),
method = "class",
weights = ifelse(df_clustering$dominant_outcome == "Low Variance",
class_weights["Low Variance"],
class_weights["High Variance"]),
control = rpart.control(
cp = 0.01,
minsplit = 10,
minbucket = 5,
maxdepth = 10
)
)
# Save a very high resolution plot to see all details
png("tree_high_res.png", width = 7000, height = 3000, res = 300)
# rpart.plot(cart_purity,
#            type = 4,
#            extra = 104,
#            under = FALSE,
#            faclen = 0,
#            cex = 0.6,  # Smaller text to fit more
#            tweak = 1.2)
#
rpart.plot(
cart_purity,
type = 4,
extra = 104,
under = TRUE,      # put labels underneath
faclen = 0,
cex = 0.6,
tweak = 1.2,
fallen.leaves = TRUE,
nn = TRUE          # <— shows node numbers on the plot
)
dev.off()
# Get full frame info
frame_info <- cart_purity$frame
# Add node IDs
frame_info$node_id <- as.numeric(row.names(frame_info))
terminal_nodes = frame_info %>%
dplyr::filter(var == "<leaf>") %>%
dplyr::mutate(
Node_ID = as.numeric(row.names(.)),
Predicted_Class = ifelse(yval == 1, "High Variance", "Low Variance"),
N_Samples = n,
P_HighVar = yval2[, 4],
P_LowVar  = yval2[, 5],
Node_Percent = yval2[, 6]
) %>%
dplyr::select(Node_ID, Predicted_Class, N_Samples, P_HighVar, P_LowVar, Node_Percent)
1e6-1
